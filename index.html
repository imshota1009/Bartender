<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éê„Éº„ÉÜ„É≥„ÉÄ„Éº„Ç≤„Éº„É†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Playfair+Display:wght@700&family=M+PLUS+Rounded+1c:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111;
            background-image: radial-gradient(circle at center, #333 0%, #111 70%);
            overflow: hidden;
        }
        .font-title { font-family: 'Playfair Display', serif; }
        .font-jp { font-family: 'M PLUS Rounded 1c', sans-serif; }
        
        #game-container {
            width: 100%;
            max-width: 800px;
            height: 95vh;
            max-height: 900px;
            background: #262626;
            box-shadow: 0 0 40px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.5);
        }

        #bar-counter {
            background-color: #6d4c41;
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.05) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.05) 50%, rgba(255, 255, 255, 0.05) 75%, transparent 75%, transparent);
            background-size: 30px 30px;
            border-top: 5px solid #8d6e63;
        }

        .ingredient-bottle {
            transition: all 0.2s ease-in-out; cursor: pointer; position: relative;
            height: 120px; border-radius: 10px 10px 0 0;
            display: flex; align-items: flex-end; justify-content: center; padding-bottom: 8px;
            color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            box-shadow: inset 0 -20px 30px -10px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.2);
            font-size: 0.8rem; text-align: center;
        }
        .ingredient-bottle:hover { transform: scale(1.05) translateY(-5px); filter: brightness(1.2); }
        .ingredient-bottle.selected { transform: scale(1.1) translateY(-10px); filter: brightness(1.5); box-shadow: 0 0 15px 5px var(--glow-color, #fff); }

        .shake-animation { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0) rotate(-1deg); } 20%, 80% { transform: translate3d(2px, 0, 0) rotate(2deg); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0) rotate(-4deg); } 40%, 60% { transform: translate3d(4px, 0, 0) rotate(4deg); }
        }
        
        #customer { transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; }
        #customer.slide-in { transform: translateX(0) scale(1); opacity: 1; } #customer.slide-out { transform: translateX(100px) scale(0.8); opacity: 0; }
        
        #customer-dialogue {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background-color: white; color: #333; padding: 8px 16px; border-radius: 12px;
            max-width: 250px; text-align: center; opacity: 0;
            transition: opacity 0.3s, transform 0.3s; pointer-events: none; z-index: 10;
        }
        #customer-dialogue.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
        #customer-dialogue::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border-width: 10px; border-style: solid; border-color: white transparent transparent transparent; }
        
        #game-overlay { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); }
        
        #timer-display { position: relative; }
        .timer-danger { animation: pulse-danger 1s infinite; }
        @keyframes pulse-danger { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 50% { transform: scale(1.1); box-shadow: 0 0 10px 10px rgba(220, 38, 38, 0); } }

        .floating-text { position: absolute; font-size: 1.5rem; font-weight: bold; animation: float-up 1.5s ease-out forwards; pointer-events: none; z-index: 20; }
        @keyframes float-up { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-50px); opacity: 0; } }

        @keyframes fill-glass { from { height: 0%; } to { height: var(--fill-height, 80%); } }
        .animate-fill { animation: fill-glass 0.5s ease-out forwards; }
        
        .ice-cube {
            position: absolute; background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.9); border-radius: 4px;
        }
        .button-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 10px 15px rgba(59, 130, 246, 0); } }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen">
    <audio id="bgm-audio" src="background/Èü≥Ê•Ω„ÅØbackground" loop></audio>
    <div id="game-container" class="mx-auto rounded-2xl shadow-2xl p-4 md:p-6 flex flex-col relative overflow-hidden border-4 border-gray-700">
        
        <header class="flex justify-between items-center mb-4 px-2 relative">
            <div id="score-display" class="relative">
                <h2 class="text-xl md:text-2xl font-bold">„Çπ„Ç≥„Ç¢: <span id="score">0</span></h2>
            </div>
            <div class="flex items-center gap-2 md:gap-4">
                 <button id="prepare-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg shadow-md text-sm font-jp transition-transform transform hover:scale-105">ÊùêÊñôË°®Á§∫</button>
                <div id="timer-display" class="bg-red-600 rounded-full px-4 py-2 transition-all duration-300">
                    <h2 class="text-xl md:text-2xl font-bold">ÊôÇÈñì: <span id="timer">60</span></h2>
                </div>
            </div>
        </header>

        <main class="flex-grow flex flex-col">
            <div id="customer-area" class="h-1/4 flex flex-col items-center justify-end mb-4 relative">
                <div id="customer-dialogue" class="font-jp"></div>
                <div id="customer" class="text-6xl mb-2 opacity-0 transform -translate-x-12">üßë‚Äçüíº</div>
                <div id="order-bubble" class="bg-gray-200 p-3 rounded-lg shadow-lg text-gray-800 flex flex-col items-center gap-2 opacity-0 transition-opacity duration-300">
                    <div id="customer-name" class="font-bold font-jp text-sm text-gray-600"></div>
                    <div class="flex items-center gap-2">
                         <p class="font-bold font-jp">Ê≥®Êñá:</p> <div id="order-text" class="font-bold text-lg font-jp"></div> <div id="order-ingredients" class="flex gap-2"></div>
                    </div>
                </div>
            </div>

            <div id="bar-counter" class="p-4 flex-grow flex items-center justify-between gap-4 rounded-lg">
                <div class="w-1/3 flex flex-col items-center justify-around h-full">
                    <div id="shaker-area" class="w-24 h-40 bg-gray-400 rounded-t-lg border-4 border-gray-300 relative flex items-end overflow-hidden shadow-inner">
                        <div id="shaker-ice-cubes" class="absolute inset-0"></div>
                        <div id="shaker-contents" class="w-full h-full transition-all duration-300"></div>
                    </div>
                    <div class="flex flex-col gap-2 w-full mt-4">
                        <button id="add-ice-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 font-jp">Ê∞∑„ÇíÂÖ•„Çå„Çã</button>
                        <button id="shake-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 font-jp">„Ç∑„Çß„Ç§„ÇØÔºÅ</button>
                        <button id="reset-button" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 font-jp">„É™„Çª„ÉÉ„Éà</button>
                    </div>
                </div>
                <div class="w-2/3 flex flex-col items-center justify-center">
                    <div id="cocktail-glass" class="w-32 h-40 relative">
                        <svg viewBox="0 0 100 120" class="w-full h-full filter drop-shadow-lg"><path d="M 10 120 L 40 50 L 60 50 L 90 120 Z" fill="rgba(255,255,255,0.1)"/><path d="M 0 40 L 100 40 L 95 50 L 5 50 Z" fill="rgba(255,255,255,0.1)"/><path d="M 45 40 L 55 0 L 55 40 Z" fill="rgba(255,255,255,0.1)"/></svg>
                        <div id="final-cocktail" class="absolute bottom-[2px] left-1/2 -translate-x-12 w-[78%] h-0 bg-transparent rounded-sm"></div>
                    </div>
                     <div id="result-text" class="text-2xl font-bold mt-2 h-8 font-jp"></div>
                </div>
            </div>
        </main>
        
        <footer id="ingredient-shelf" class="grid grid-cols-5 md:grid-cols-9 gap-2 mt-4 p-4 bg-black/30 rounded-lg"></footer>

        <div id="game-overlay" class="absolute inset-0 flex flex-col items-center justify-center transition-opacity duration-500 z-30">
            <h1 class="font-title text-6xl md:text-8xl mb-4">Bartender</h1>
            <h2 id="final-score" class="text-4xl mb-8 hidden font-jp"></h2>
            <button id="start-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-2xl shadow-lg transition-transform transform font-jp button-pulse">„Çπ„Çø„Éº„Éà</button>
            <button id="retry-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-2xl shadow-lg transition-transform transform hidden font-jp button-pulse">„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Game Data ---
        const INGREDIENTS = { vodka: { name: '„Ç¶„Ç©„ÉÉ„Ç´', color: '#e0f7fa', glow: '#80deea' }, gin: { name: '„Ç∏„É≥', color: '#e8f5e9', glow: '#a5d6a7' }, rum: { name: '„É©„É†', color: '#ffecb3', glow: '#ffe082' }, cassis: { name: '„Ç´„Ç∑„Çπ', color: '#4a148c', glow: '#ce93d8' }, lime: { name: '„É©„Ç§„É†', color: '#d4e157', glow: '#e6ee9c' }, orangeJuice: { name: '„Ç™„É¨„É≥„Ç∏J', color: '#ff9800', glow: '#ffb74d' }, tonic: { name: '„Éà„Éã„ÉÉ„ÇØ', color: '#cfd8dc', glow: '#eceff1' }, cola: { name: '„Ç≥„Éº„É©', color: '#3e2723', glow: '#a1887f' }, gingerAle: { name: '„Ç∏„É≥„Ç∏„É£„Éº„Ç®„Éº„É´', color: '#fbc02d', glow: '#fff176' }};
        const COCKTAILS = [ { name: '„Çπ„ÇØ„É™„É•„Éº„Éâ„É©„Ç§„Éê„Éº', ingredients: ['vodka', 'orangeJuice'], needsIce: true }, { name: '„Ç∏„É≥„Éà„Éã„ÉÉ„ÇØ', ingredients: ['gin', 'tonic', 'lime'], needsIce: true }, { name: '„Ç≠„É•„Éº„Éê„É™„Éñ„É¨', ingredients: ['rum', 'cola', 'lime'], needsIce: true }, { name: '„É¢„Çπ„Ç≥„Éü„É•„Éº„É´', ingredients: ['vodka', 'gingerAle', 'lime'], needsIce: true }, { name: '„Ç´„Ç∑„Çπ„Ç™„É¨„É≥„Ç∏', ingredients: ['cassis', 'orangeJuice'], needsIce: true }, { name: '„É©„É†„Ç≥„Éº„ÇØ', ingredients: ['rum', 'cola'], needsIce: true }, { name: '„Ç∏„É≥„Éê„ÉÉ„ÇØ', ingredients: ['gin', 'gingerAle', 'lime'], needsIce: true }];
        const CUSTOMERS = [ { name: "„Éê„Éº„ÅÆÂ∏∏ÈÄ£", emoji: 'üßë‚Äçüíº', quotes: { order: ["„ÅÑ„Å§„ÇÇ„ÅÆÈ†º„ÇÄ„Çà", "‰ªäÊó•„ÅØ„Çπ„ÇØ„É™„É•„Éº„Éâ„É©„Ç§„Éê„ÉºÊ∞óÂàÜ„Å†"], success: ["„Åì„Çå„Å†„Çà„ÄÅ„Åì„ÇåÔºÅ", "„ÅÜ„Åæ„ÅÑÔºÅ„Åæ„ÅüÊù•„Çã„Çà"], fail: ["„ÅÜ„Éº„Çì„ÄÅÂë≥„ÅåÈÅï„ÅÜ„Å™‚Ä¶", "„Åì„Çå„ÅØÈ†º„Çì„Åß„Å™„ÅÑ„Åû"] }}, { name: "ÁßëÂ≠¶ËÄÖ", emoji: 'üë©‚Äçüî¨', quotes: { order: ["ÂÆåÁíß„Å™ÊØîÁéá„ÅßÈ†º„ÇÄ", "ÂÆüÈ®ìÊàêÂäü„ÅÆÁ•ù„ÅÑ„Å†"], success: ["Ë®àÁÆóÈÄö„Çä„ÄÅÂÆåÁíß„Å™Âë≥„Å†", "Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ"], fail: ["ÈÖçÂêà„ÇíÈñìÈÅï„Åà„Åü„Å™Ôºü", "„Åì„Çå„ÅØÂ§±Êïó‰Ωú„Å†"] }}, { name: "Ëä∏Ë°ìÂÆ∂", emoji: 'üë®‚Äçüé®', quotes: { order: ["„Ç§„É≥„Çπ„Éî„É¨„Éº„Ç∑„Éß„É≥„ÅåÊ¨≤„Åó„ÅÑ", "Ëä∏Ë°ìÁöÑ„Å™‰∏ÄÊùØ„Çí"], success: ["Ëâ≤ÂΩ©Ë±ä„Åã„Å™Âë≥„Å†ÔºÅ", "ÂÇë‰Ωú„Å†„Å≠ÔºÅ"], fail: ["Âêõ„Å´„ÅØÊâçËÉΩ„Åå„Å™„ÅÑ„Å™", "Ëâ≤„ÅåÊøÅ„Å£„Å¶„ÅÑ„Çã‚Ä¶"] }}, { name: "ÂÆáÂÆôÈ£õË°åÂ£´", emoji: 'üë©‚ÄçüöÄ', quotes: { order: ["ÂÆáÂÆô„ÅÆÂë≥„ÇíÈ†º„ÇÄ", "ÁÑ°ÈáçÂäõ„Å™ÊÑü„Åò„Åß"], success: ["„Åæ„Çã„ÅßÊòüÂ±ë„ÅÆ„Çà„ÅÜ„Å†‚Ä¶", "‰∫§‰ø°ÊàêÂäüÔºÅ"], fail: ["Âú∞ÁêÉ„ÅÆÂë≥„ÅØ„Åì„Çì„Å™„ÇÇ„ÅÆ„Åã", "ËªåÈÅì„Åå„Åö„Çå„Å¶„ÅÑ„Çã"] }}, { name: "Êé¢ÂÅµ", emoji: 'üïµÔ∏è', quotes: { order: ["‰∫ã‰ª∂„ÅÆÂåÇ„ÅÑ„Åå„Åô„Çã‰∏ÄÊùØ„Çí", "„Éè„Éº„Éâ„Éú„Ç§„É´„Éâ„Å´È†º„ÇÄ"], success: ["„Å™„Çã„Åª„Å©„ÄÅ„Åù„ÅÜ„ÅÑ„ÅÜ„Åì„Å®„Åã‚Ä¶", "Ë¨é„ÅØÂÖ®„Å¶Ëß£„Åë„Åü"], fail: ["ÁäØ‰∫∫„ÅØ„ÅäÂâç„Å†„Å™‚Ä¶", "„Åæ„Å†Áîò„ÅÑ„Å™„ÄÅÂùä„ÇÑ"] }}, { name: "„É≠„ÉÉ„ÇØ„Çπ„Çø„Éº", emoji: 'üë©‚Äçüé§', quotes: { order: ["ÊúÄÈ´ò„Å´„ÇØ„É¨„Ç§„Ç∏„Éº„Å™„ÇÑ„Å§„ÇíÔºÅ", "Âñâ„ÇíÊΩ§„Åó„Åü„ÅÑ„Çì„Å†"], success: ["„É≠„ÉÉ„ÇØ„É≥„É≠„Éº„É´ÔºÅ", "„Ç™„Éº„Éá„Ç£„Ç®„É≥„Çπ„ÇÇÊ∫ÄË∂≥„Å†„ÅúÔºÅ"], fail: ["„Éé„Ç§„Ç∫„ÅåÂ§ö„ÅÑ„Å™", "„ÉÅ„É•„Éº„Éã„É≥„Ç∞„Åå„Åö„Çå„Å¶„Çã„Åú"] }}, { name: "„Éû„Ç∏„Ç∑„É£„É≥", emoji: 'üé©', quotes: { order: ["„Çø„Éç„ÇÇ‰ªïÊéõ„Åë„ÇÇ„Å™„ÅÑ„ÇÑ„Å§„Çí", "„Çµ„Éó„É©„Ç§„Ç∫„ÇíÈ†º„ÇÄ"], success: ["„Éñ„É©„Éú„ÉºÔºÅË¶ã‰∫ã„Å™ÊâãÂìÅ„Å†", "„Åù„Çå„Åß„ÅØ„ÄÅÁ®ÆÊòé„Åã„Åó„Å®Ë°å„Åì„ÅÜ„Åã"], fail: ["„Çø„Éç„Åå„Åø„Åà„Åø„Åà„Å†", "„Ç§„É™„É•„Éº„Ç∏„Éß„É≥„Å´„ÅØÁ®ãÈÅ†„ÅÑ"] }}, { name: "Ë¶≥ÂÖâÂÆ¢", emoji: 'ü§≥', quotes: { order: ["„Ç™„Çπ„Çπ„É°„ÅØ„Å©„Çå„Éá„Çπ„Ç´Ôºü", "Êò†„Åà„Çã„ÇÑ„Å§„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„ÅôÔºÅ"], success: ["„Ç™„ÉºÔºÅ„Éì„É•„Éº„ÉÜ„Ç£„Éï„É´ÔºÅ", "„Åì„Çå„ÅØ„Éû„Çπ„Éà„Éê„Ç§„Å≠ÔºÅ"], fail: ["„Å°„Çá„Å£„Å®„Ç¨„ÉÉ„Ç´„É™‚Ä¶", "„Ç¨„Ç§„Éâ„Éñ„ÉÉ„ÇØ„Å®ÈÅï„ÅÜ‚Ä¶"] }}];
        const MILLIONAIRE_CUSTOMER = { name: "Â§ßÂØåË±™", emoji: 'ü§ë', quotes: { order: ["ÊúÄÈ´òÁ¥ö„ÅÆ„ÇÇ„ÅÆ„ÇíÈ†º„ÇÄ", "Âêõ„ÅÆËÖï„ÇíË¶ã„Åõ„Å¶„Åø„Çç"], success: ["Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ„ÉÅ„ÉÉ„Éó„Å†„ÄÅ„Å®„Å£„Å¶„Åä„Åç„Åü„Åæ„Åà", "Ê∞ó„Å´ÂÖ•„Å£„Åü„ÄÅ„Åæ„ÅüÊù•„Çà„ÅÜ"], fail: ["„Åå„Å£„Åã„Çä„Å†„ÄÅÊôÇÈñì„ÅØÈáë„Å™„Çä„Å†„Åû", "ÁßÅ„ÅÆËàå„ÅØ„Åî„Åæ„Åã„Åõ„Çì„Çà"] }};
        const DEATH_CUSTOMER = { name: "ÔºüÔºüÔºü", emoji: 'üíÄ', quotes: { order: ["‚Ä¶Âñâ„ÅåÊ∏á„ÅÑ„Å¶„Å™", "‰æã„ÅÆ„ÇÇ„ÅÆ„Çí‚Ä¶È†º„ÇÅ„Çã„ÅãÔºü", "È≠Ç„ÇíÊè∫„Åï„Å∂„Çã‰∏ÄÊùØ„Çí‚Ä¶"], success: ["‚Ä¶ÊÇ™„Åè„Å™„ÅÑ„ÄÇ„Åæ„Åü‰ºö„Åä„ÅÜ", "„Éï„Éï‚Ä¶È≠Ç„ÅåÊΩ§„Å£„Åü„Åû", "‚Ä¶„ÅäÂâç„ÄÅÊ∞ó„Å´ÂÖ•„Å£„Åü"], fail: ["‚Ä¶Ê¨°„ÅØ„Å™„ÅÑ„Å®ÊÄù„Åà", "ÊÑö„Åã„Å™‰∫∫Èñì„ÇÅ‚Ä¶", "„ÅäÂâç„ÅÆÈ≠Ç„ÅØÊøÅ„Å£„Å¶„ÅÑ„Çã„Å™"] }};
        
        // --- DOM Elements ---
        const dom = {};
        const elementIds = ['score', 'timer', 'timer-display', 'order-text', 'order-ingredients', 'ingredient-shelf', 'shaker-area', 'shaker-contents', 'shaker-ice-cubes', 'final-cocktail', 'result-text', 'customer', 'customer-name', 'shake-button', 'reset-button', 'start-button', 'retry-button', 'game-overlay', 'final-score', 'score-display', 'customer-dialogue', 'order-bubble', 'add-ice-button', 'prepare-button', 'bgm-audio'];
        elementIds.forEach(id => {
            const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
            dom[`${camelCaseId}El`] = document.getElementById(id);
        });

        // --- Game State ---
        let state = { score: 0, timeLeft: 60, timerInterval: null, currentOrder: null, currentCustomer: null, shakerContents: [], shakerHasIce: false, isGameRunning: false, canInteract: true, isDeathCustomerActive: false, isMillionaireActive: false };

        // --- Sound Engine (Tone.js) ---
        let sounds = {};
        let isAudioReady = false;
        
        function setupSounds() {
            sounds = {
                pour: new Tone.Synth({ oscillator: { type: 'fmsine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.2 } }).toDestination(),
                shake: new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.01, decay: 0.15, sustain: 0, release: 0.1 } }).toDestination(),
                ice: new Tone.MetalSynth({ frequency: 200, envelope: { attack: 0.001, decay: 0.1, release: 0.01 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination(),
                success: new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination(),
                fail: new Tone.PolySynth(Tone.Synth, { oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.4, sustain: 0, release: 0.2 } }).toDestination(),
                timeBonus: new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.2 } }).toDestination(),
                tip: new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.2, release: 0.3 } }).toDestination(),
            };
            isAudioReady = true;
        }

        async function startAudio() {
            // Start Tone.js for sound effects
            if (isAudioReady && Tone.context.state !== 'running') {
                await Tone.start();
            }
            // Play BGM audio file
            if (dom.bgmAudioEl) {
                dom.bgmAudioEl.play().catch(e => console.error("BGM„ÅÆÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", e));
            }
        }

        function stopAudio() {
            if (dom.bgmAudioEl) {
                dom.bgmAudioEl.pause();
                dom.bgmAudioEl.currentTime = 0;
            }
        }

        function playSound(sound, ...args) {
            if (!isAudioReady) return;
            if (sound === 'success') sounds.success.triggerAttackRelease(['C4', 'E4', 'G4'], '8n');
            else if (sound === 'fail') sounds.fail.triggerAttackRelease(['C3', 'C#3'], '4n');
            else if (sound === 'ice') sounds.ice.triggerAttackRelease('C3', '8n', Tone.now() + 0.05);
            else if (sound === 'timeBonus') sounds.timeBonus.triggerAttackRelease(['G4', 'C5', 'E5'], '8n');
            else if (sound === 'tip') sounds.tip.triggerAttackRelease(['C5', 'E5', 'G5', 'C6'], '4n');
            else if (sounds[sound]) sounds[sound].triggerAttackRelease(...args);
        }
        
        // --- Game Logic ---
        function populateShelf() {
            dom.ingredientShelfEl.innerHTML = '';
            for (const key in INGREDIENTS) {
                const bottle = document.createElement('div');
                bottle.className = 'ingredient-bottle font-bold p-2 font-jp';
                bottle.textContent = INGREDIENTS[key].name;
                bottle.style.backgroundColor = INGREDIENTS[key].color;
                bottle.style.color = getContrastingTextColor(INGREDIENTS[key].color);
                bottle.style.setProperty('--glow-color', INGREDIENTS[key].glow);
                bottle.dataset.ingredient = key;
                bottle.addEventListener('click', () => addIngredient(key, bottle));
                dom.ingredientShelfEl.appendChild(bottle);
            }
        }
        
        function getContrastingTextColor(hex){ const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16); return((r*299)+(g*587)+(b*114))/1000>=128?'#111':'#fff'; }

        function startGame() {
             if (dom.ingredientShelfEl.childElementCount === 0) {
                populateShelf();
            }
            Object.assign(state, { score: 0, timeLeft: 60, isGameRunning: true, canInteract: false, isDeathCustomerActive: false, isMillionaireActive: false, currentCustomer: null });
            updateScore(); resetShaker();
            dom.gameOverlayEl.style.opacity = '0'; dom.gameOverlayEl.style.pointerEvents = 'none';
            dom.startButtonEl.classList.add('hidden'); dom.retryButtonEl.classList.add('hidden'); dom.finalScoreEl.classList.add('hidden');
            generateOrder();
            state.timerInterval = setInterval(updateTimer, 1000);
        }
        
        function endGame() {
            state.isGameRunning = false; clearInterval(state.timerInterval);
            stopAudio();
            dom.timerDisplayEl.classList.remove('timer-danger');
            dom.gameOverlayEl.style.opacity = '1'; dom.gameOverlayEl.style.pointerEvents = 'auto';
            dom.finalScoreEl.textContent = `ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: ${state.score}`;
            dom.finalScoreEl.classList.remove('hidden'); dom.retryButtonEl.classList.remove('hidden');
        }
        
        function updateTimer() {
            state.timeLeft -= state.isDeathCustomerActive ? 2 : 1;
            if (state.timeLeft < 0) state.timeLeft = 0;
            dom.timerEl.textContent = state.timeLeft;
            if (state.timeLeft <= 0) endGame();
        }

        function showDialogue(lines) {
            dom.customerDialogueEl.textContent = lines[Math.floor(Math.random() * lines.length)];
            dom.customerDialogueEl.classList.add('show');
        }

        function generateOrder() {
            state.canInteract = false;
            state.isDeathCustomerActive = false;
            state.isMillionaireActive = false;

            if (state.currentCustomer) {
                dom.customerEl.classList.remove('slide-in');
                dom.customerEl.classList.add('slide-out');
                dom.orderBubbleEl.style.opacity = '0';
                dom.customerDialogueEl.classList.remove('show');
            }
            setTimeout(() => {
                state.currentOrder = COCKTAILS[Math.floor(Math.random() * COCKTAILS.length)];
                dom.orderTextEl.textContent = state.currentOrder.name;

                const rand = Math.random();
                if (rand < 0.15) { // 15% chance for Millionaire
                    state.currentCustomer = MILLIONAIRE_CUSTOMER;
                    state.isMillionaireActive = true;
                } else if (rand < 0.35) { // 20% chance for Death (0.35 - 0.15)
                    state.currentCustomer = DEATH_CUSTOMER;
                    state.isDeathCustomerActive = true;
                } else { // 65% for regular
                    state.currentCustomer = CUSTOMERS[Math.floor(Math.random() * CUSTOMERS.length)];
                }

                dom.customerEl.classList.toggle('scale-125', state.isDeathCustomerActive || state.isMillionaireActive);
                dom.timerDisplayEl.classList.toggle('timer-danger', state.isDeathCustomerActive);
                
                dom.customerEl.textContent = state.currentCustomer.emoji;
                dom.customerNameEl.textContent = state.currentCustomer.name;
                dom.customerEl.classList.remove('slide-out');
                dom.customerEl.classList.add('slide-in');

                setTimeout(() => {
                    dom.orderBubbleEl.style.opacity = '1';
                    showDialogue(state.currentCustomer.quotes.order);
                    state.canInteract = true;
                }, 500);

                dom.orderIngredientsEl.innerHTML = '';
                [...state.currentOrder.ingredients].sort(() => 0.5 - Math.random()).forEach(key => {
                    const div = document.createElement('div');
                    div.style.cssText = `width:24px; height:24px; background-color:${INGREDIENTS[key].color}; border-radius:9999px; border:3px solid #4b5563; box-shadow: 0 1px 3px rgba(0,0,0,0.2);`;
                    div.title = INGREDIENTS[key].name; dom.orderIngredientsEl.appendChild(div);
                });
            }, state.currentCustomer ? 700 : 0);
        }

        function addIngredient(key, element) {
            if (!state.isGameRunning || !state.canInteract || state.shakerContents.length >= 5) return;
            state.shakerContents.push(key);
            updateShakerVisual();
            element.classList.add('selected');
            setTimeout(() => element.classList.remove('selected'), 500);
            playSound('pour', 'C3', '8n');
        }

        function addIce() {
            if (!state.isGameRunning || !state.canInteract || state.shakerHasIce) return;
            state.shakerHasIce = true;
            updateShakerVisual();
            playSound('ice');
        }
        
        function resetShaker() {
            state.shakerContents = []; state.shakerHasIce = false;
            updateShakerVisual();
            dom.finalCocktailEl.classList.remove('animate-fill');
            dom.finalCocktailEl.style.height = '0%';
            dom.resultTextEl.textContent = '';
        }

        function updateShakerVisual() {
            const liquidHeight = (state.shakerContents.length / 5) * 100;
            const mixedColor = state.shakerContents.length > 0 ? '#' + state.shakerContents.reduce((avg, key) => {
                let c = INGREDIENTS[key].color.substring(1);
                avg[0] += parseInt(c.substring(0,2), 16); avg[1] += parseInt(c.substring(2,4), 16); avg[2] += parseInt(c.substring(4,6), 16);
                return avg;
            }, [0, 0, 0]).map(c => Math.round(c / state.shakerContents.length).toString(16).padStart(2, '0')).join('') : 'transparent';
            dom.shakerContentsEl.style.background = `linear-gradient(to top, ${mixedColor} 0%, ${mixedColor} ${liquidHeight}%, transparent ${liquidHeight}%)`;

            dom.shakerIceCubesEl.innerHTML = '';
            if (state.shakerHasIce) {
                for (let i = 0; i < 5; i++) {
                    const ice = document.createElement('div');
                    ice.className = 'ice-cube';
                    ice.style.cssText = `width:${Math.random()*10+15}px; height:${Math.random()*10+15}px; left:${Math.random()*70}%; bottom:${Math.random()*(liquidHeight>20?liquidHeight-20:0)}%; transform:rotate(${Math.random()*90}deg);`;
                    dom.shakerIceCubesEl.appendChild(ice);
                }
            }
        }

        function showFloatingText(text, color, element) {
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.textContent = text;
            el.style.color = color;
            element.appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }

        function shake() {
            if (!state.isGameRunning || !state.canInteract || (state.shakerContents.length === 0 && !state.shakerHasIce)) return;
            state.canInteract = false; dom.customerDialogueEl.classList.remove('show');
            dom.shakerAreaEl.classList.add('shake-animation');
            for(let i=0; i<5; i++) setTimeout(()=>playSound('shake', '8n'), i*80);
            setTimeout(() => { dom.shakerAreaEl.classList.remove('shake-animation'); checkRecipe(); }, 500);
        }

        function checkRecipe() {
            const isCorrect = JSON.stringify([...state.currentOrder.ingredients].sort()) === JSON.stringify([...state.shakerContents].sort()) && state.currentOrder.needsIce === state.shakerHasIce;
            
            dom.finalCocktailEl.style.background = dom.shakerContentsEl.style.background;
            dom.finalCocktailEl.style.setProperty('--fill-height', '80%');
            dom.finalCocktailEl.classList.add('animate-fill');

            if (isCorrect) {
                let points = 100;
                if(state.isDeathCustomerActive) points = 300;
                
                state.score += points;
                showFloatingText(`+${points}`, '#84cc16', dom.scoreDisplayEl);

                if (state.isMillionaireActive) {
                    const tip = 200;
                    state.score += tip;
                    setTimeout(() => { 
                        showFloatingText(`„ÉÅ„ÉÉ„Éó +${tip}!`, '#ffd700', dom.scoreDisplayEl);
                        playSound('tip');
                    }, 300);
                }

                state.timeLeft += 10;
                showFloatingText('+10s', '#34d399', dom.timerDisplayEl);
                showDialogue(state.currentCustomer.quotes.success);
                dom.resultTextEl.textContent = 'ÊàêÂäüÔºÅ üòã';
                dom.resultTextEl.style.color = '#65a30d';
                dom.timerEl.textContent = state.timeLeft;
                playSound('success');
                playSound('timeBonus');
                setTimeout(() => { resetShaker(); generateOrder(); }, 2000);
            } else {
                const points = state.isDeathCustomerActive ? -50 : -20;
                state.score += points;
                showFloatingText(`${points}`, '#ef4444', dom.scoreDisplayEl);
                showDialogue(state.currentCustomer.quotes.fail);
                dom.resultTextEl.textContent = 'Â§±Êïó... üòñ';
                dom.resultTextEl.style.color = '#dc2626';
                if (state.currentCustomer.emoji !== 'üíÄ') dom.customerEl.textContent = 'üò†';
                playSound('fail');
                setTimeout(() => { resetShaker(); generateOrder(); }, 2000);
            }
            updateScore();
        }

        function updateScore() { if (state.score < 0) state.score = 0; dom.scoreEl.textContent = state.score; }

        function initializeGame() {
            setupSounds();
            populateShelf();

            dom.startButtonEl.addEventListener('click', () => {
                startAudio();
                startGame();
            });
            dom.retryButtonEl.addEventListener('click', startGame);
            dom.shakeButtonEl.addEventListener('click', shake);
            dom.resetButtonEl.addEventListener('click', () => { if (state.canInteract) resetShaker(); });
            dom.addIceButtonEl.addEventListener('click', () => { if(state.canInteract) addIce(); });
            dom.prepareButtonEl.addEventListener('click', populateShelf);
        }

        initializeGame();
    });
    </script>
</body>
</html>







